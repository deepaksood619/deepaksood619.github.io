"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5957],{603905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(667294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(a),h=s,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||r;return a?n.createElement(m,i(i({ref:t},u),{},{components:a})):n.createElement(m,i({ref:t},u))}));function m(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=a.length,i=new Array(r);i[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:s,i[1]=o;for(var c=2;c<r;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},792841:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var n=a(487462),s=(a(667294),a(603905));const r={},i="Vault",o={unversionedId:"computer-science/security/vault",id:"computer-science/security/vault",title:"Vault",description:"Vault is a tool for securely accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. Vault provides a unified interface to any secret, while providing tight access control and recording a detailed audit log.",source:"@site/docs/computer-science/security/vault.md",sourceDirName:"computer-science/security",slug:"/computer-science/security/vault",permalink:"/computer-science/security/vault",draft:!1,editUrl:"https://github.com/deepaksood619/deepaksood619.github.io/tree/main/docs/computer-science/security/vault.md",tags:[],version:"current",lastUpdatedAt:1677955187,formattedLastUpdatedAt:"Mar 4, 2023",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Tools",permalink:"/computer-science/security/tools"},next:{title:"Vulnerabilities",permalink:"/computer-science/security/vulnerabilities"}},l={},c=[{value:"Features",id:"features",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Options",id:"options",level:2},{value:"Option 1: Distributing Tokens",id:"option-1-distributing-tokens",level:2},{value:"Commands",id:"commands",level:2},{value:"K8s annotations",id:"k8s-annotations",level:2},{value:"App Roles",id:"app-roles",level:2},{value:"Review Approle",id:"review-approle",level:2},{value:"Database Rotation",id:"database-rotation",level:2},{value:"Static Roles",id:"static-roles",level:2},{value:"Audit Devices",id:"audit-devices",level:2},{value:"Questions",id:"questions",level:2},{value:"Steps",id:"steps",level:2},{value:"Comparision",id:"comparision",level:2}],u={toc:c},p="wrapper";function d(e){let{components:t,...r}=e;return(0,s.kt)(p,(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"vault"},"Vault"),(0,s.kt)("p",null,"Vault is a tool for securely accessing ",(0,s.kt)("em",{parentName:"p"},"secrets"),". A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. Vault provides a unified interface to any secret, while providing tight access control and recording a detailed audit log.\nVault was built to solve the secret sprawl problem in a user-friendly and auditable way. Just as immutable infrastructure gives operations certainty in server configurations and eliminates drift, Vault gives security certainty in when, where, and how secrets are being used across a system. It is the central source of security truth for modern architectures."),(0,s.kt)("h2",{id:"features"},"Features"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Secure Secret Storage"))),(0,s.kt)("p",null,"Arbitrary key/value secrets can be stored in Vault. Vault encrypts these secrets prior to writing them to persistent storage, so gaining access to the raw storage isn't enough to access your secrets. Vault can write to disk, ",(0,s.kt)("a",{parentName:"p",href:"https://www.consul.io/"},"Consul"),", and more.- ",(0,s.kt)("strong",{parentName:"p"},"Dynamic Secrets")),(0,s.kt)("p",null,"Vault can generate secrets on-demand for some systems, such as AWS or SQL databases. For example, when an application needs to access an S3 bucket, it asks Vault for credentials, and Vault will generate an AWS keypair with valid permissions on demand. After creating these dynamic secrets, Vault will also automatically revoke them after the lease is up. Thus, even if the system is breached, the attacker only has a short window of opportunity before the secret gets re-generated and access is revoked.- ",(0,s.kt)("strong",{parentName:"p"},"Data Encryption")),(0,s.kt)("p",null,"Vault can encrypt and decrypt data without storing it. This allows security teams to define encryption parameters and developers to store encrypted data in a location such as SQL without having to design their own encryption methods.- ",(0,s.kt)("strong",{parentName:"p"},"Leasing and Renewal")),(0,s.kt)("p",null,"All secrets in Vault have aleaseassociated with them. At the end of the lease, Vault will automatically revoke that secret. Clients are able to renew leases via built-in renew APIs.- ",(0,s.kt)("strong",{parentName:"p"},"Revocation")),(0,s.kt)("p",null,"Vault has built-in support for secret revocation. Vault can revoke not only single secrets, but a tree of secrets, for example all secrets read by a specific user, or all secrets of a particular type. Revocation assists in key rolling as well as locking down systems in the case of an intrusion.- ",(0,s.kt)("strong",{parentName:"p"},"Limit the internal surface area of a breach to a single application instance")),(0,s.kt)("p",null,"Fine-grained ACLs lets Vault grants specific, limited communication permissions for each secret. If a secret is compromised, it only provides access to a single service and not the entire infrastructure. In many existing security managers, obtaining one key will let an attacker have free reign throughout the system.- ",(0,s.kt)("strong",{parentName:"p"},"Generate an audit trail of service communication")),(0,s.kt)("p",null,"Each time a secret is generated it creates an audit log which can be used to determine the specific compromised resource in the datacenter. For example, if an application that does not have access to a database attempts to make a connection, it is clear that there has been a compromise. The audit log can be used by operators and security teams to pinpoint tainted servers and take the proper steps to restore the security of the system as a whole. It is important to note that secrets are generatedafterthe log is stored, meaning that all access actions are guaranteed to be logged. If for some reason the log cannot be written, the secret will not be generated.- ",(0,s.kt)("strong",{parentName:"p"},"Simplify security for large operations and infrastructures")),(0,s.kt)("p",null,"Often the biggest hurdle to proper security is the complexity of the implementing the security solution. With simple installation and setup, Vault lowers the barrier to entry for organizations to use responsible secret management to secure their distributed infrastructure. Secrets can be written from the command line or the ",(0,s.kt)("a",{parentName:"p",href:"http://www.google.com/url?q=http%3A%2F%2Fvaultproject.io%2Fdocs%2Fhttp%2Findex.html&sa=D&sntz=1&usg=AFQjCNFDA0tQawMLYkAwPLjf-UZLCImSPw"},"complete HTTP API"),".- ",(0,s.kt)("strong",{parentName:"p"},"In-transit data encryption")),(0,s.kt)("p",null,"Vault can encrypt and decrypt data without storing it. Security teams can define encryption parameters and store encrypted data in a location such as a SQL database without having to design a custom encryption method. You can read more about ",(0,s.kt)("a",{parentName:"p",href:"https://www.google.com/url?q=https%3A%2F%2Fhashicorp.com%2Fblog%2Fhow-atlas-uses-vault-for-managing-secrets.html&sa=D&sntz=1&usg=AFQjCNHM-BUqX0jdzPzHtH1Wx88qQw-yJA"},"how HashiCorp's Atlas uses Vault to encrypt GitHub OAuth tokens"),".- ",(0,s.kt)("strong",{parentName:"p"},"High-availability")),(0,s.kt)("p",null,"High-availability is a requirement for large-scale infrastructures to protect against service outages. Vault can run in multi-server mode when using a ",(0,s.kt)("a",{parentName:"p",href:"https://www.google.com/url?q=https%3A%2F%2Fvaultproject.io%2Fdocs%2Fconcepts%2Fha.html&sa=D&sntz=1&usg=AFQjCNGaIQAyr3T1AgRc__VI7utYGAx-Jg"},"backend that supports it"),", such as Consul or etcd.- ",(0,s.kt)("strong",{parentName:"p"},"Authentication methods")),(0,s.kt)("p",null,"Vault includes multiple methods for authentication so organizations can select the option that fits best with their setup. Vault ",(0,s.kt)("a",{parentName:"p",href:"https://www.google.com/url?q=https%3A%2F%2Fvaultproject.io%2Fdocs%2Fconcepts%2Fauth.html&sa=D&sntz=1&usg=AFQjCNFkbuRP8tVhRTt8aUYwQETkJZwFVw"},"currently supports")," tokens, username/password, GitHub, certificates, and more."),(0,s.kt)("h2",{id:"best-practices"},"Best Practices"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Don't let secrets live forever"),(0,s.kt)("li",{parentName:"ul"},"Distribute secrets securely"),(0,s.kt)("li",{parentName:"ul"},"Limit exposure if auth secret disclosed"),(0,s.kt)("li",{parentName:"ul"},"Break-glass procedure if auth secret stolen"),(0,s.kt)("li",{parentName:"ul"},"Detect unauthoried access to auth secrets")),(0,s.kt)("h2",{id:"options"},"Options"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Deploy Vault token alongside app"),(0,s.kt)("li",{parentName:"ol"},"Deploy approle roleid/secretid alongside app"),(0,s.kt)("li",{parentName:"ol"},"Deploy TLS client certificates and use cert auth method")),(0,s.kt)("h2",{id:"option-1-distributing-tokens"},"Option 1: Distributing Tokens"),(0,s.kt)("p",null,"One reason you might want to do this instead of using approle is its easy to use envconsul or consul-template\nIf distributing tokens directly:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"use a token role, similar to what we do with approle roles"),(0,s.kt)("li",{parentName:"ul"},"distribute single-use token with a short TTL"),(0,s.kt)("li",{parentName:"ul"},"use response wrapping to embed another longer-lived token")),(0,s.kt)("h2",{id:"commands"},"Commands"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'brew install vault\nvault -autocomplete-install\n\nvault server -dev\n\nexport VAULT_ADDR=\'http://127.0.0.1:8200\'\nvault status\nvault path-help aws\nvault path-help aws/creds/my-non-existent-role\n\n#DML\nvault kv put secret/hello foo=world\nvault kv put secret/hello foo=world excited=yes\nvault kv get secret/hello\nvault kv list kv/\n\n#DDL\nvault secrets list\nvault token create\n\n#Enable secret engine\nvault secrets enable -path=kv kv\nvault secrets enable kv\nvault secrets disable kv/\nvault secrets enable -path=aws aws\n\n# Gen\n\n# Dynamic Secrets\nvault write aws/config/root \\\n    access_key=XXX\\\n    secret_key=XXX \\\n    region=ap-south-1\n\nvault write aws/roles/my-role \\\n        credential_type=iam_user \\\n        policy_document=-<<EOF\n{\n    "Version": "2012-10-17",\n    "Statement": [\n    {\n        "Sid": "Stmt1426528957000",\n        "Effect": "Allow",\n        "Action": [\n        "ec2:*"\n        ],\n        "Resource": [\n        "*"\n        ]\n    }\n    ]\n}\nEOF\n\nvault read aws/creds/my-role\nvault lease revoke aws/creds/my-role/0bce0782-32aa-25ec-f61d-c026ff22106\n')),(0,s.kt)("h2",{id:"k8s-annotations"},"K8s annotations"),(0,s.kt)("p",null,"remove pre-populate-only, to run sidecar that can sync credentials"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"image",src:a(250824).Z,width:"1296",height:"600"})),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n    name: reminder-test\n    namespace: crons\nspec:\n    # never runs\n    schedule: "00 00 31 2 *"\n    successfulJobsHistoryLimit: 7\n    failedJobsHistoryLimit: 5\n    jobTemplate:\n    spec:\n        template:\n        metadata:\n            annotations:\n            "vault.hashicorp.com/agent-inject": "true"\n            "vault.hashicorp.com/agent-pre-populate-only": "true"\n            "vault.hashicorp.com/agent-inject-secret-credentials.json": "crons/reminder-sms"\n            "vault.hashicorp.com/role": "crons"\n            "vault.hashicorp.com/agent-inject-template-credentials.json": |\n                {{ with secret "crons/reminder-sms" }}\n                {\n                {{ range $k, $v := .Data.data }} "{{ $k }}": "{{ $v }}",\n                {{ end }} "dummy": "yes"\n                }\n                {{ end }}\n        spec:\n            containers:\n            - name: app\n                image: 331916247734.dkr.ecr.ap-south-1.amazonaws.com/reminder-messages:reminder-messages-prod-2020-07-24-22-5\n                imagePullPolicy: IfNotPresent\n                env:\n                - name: DEBUG\n                    value: "True"\n                - name: DEBUG_EMAIL\n                    value: "deepak.sood@stashfin.com"\n                - name: DEBUG_PHONE\n                    value: "9425592627"\n                - name: DEBUG_LIMIT\n                    value: "1"\n                command:\n                - /bin/bash\n                - -c\n                - |\n                    sleep infinity\n                    # sh test.sh\n            restartPolicy: OnFailure\n')),(0,s.kt)("h2",{id:"app-roles"},"App Roles"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"image",src:a(24330).Z,width:"1099",height:"527"}),"\n",(0,s.kt)("img",{alt:"image",src:a(590299).Z,width:"1099",height:"470"}),"\n",(0,s.kt)("img",{alt:"image",src:a(818231).Z,width:"1099",height:"449"}),"\n",(0,s.kt)("img",{alt:"image",src:a(808426).Z,width:"1100",height:"645"})),(0,s.kt)("h2",{id:"review-approle"},"Review Approle"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"image",src:a(467498).Z,width:"1101",height:"580"})),(0,s.kt)("h2",{id:"database-rotation"},"Database Rotation"),(0,s.kt)("p",null,'The database secrets engine generates database credentials dynamically based on configured roles. It works with a number of different databases through a plugin interface. There are a number of builtin database types and an exposed framework for running custom database types for extendability. This means that services that need to access a database no longer need to hardcode credentials: they can request them from Vault, and use Vault\'s leasing mechanism to more easily roll keys. These are referred to as "dynamic roles" or "dynamic secrets".'),(0,s.kt)("h2",{id:"static-roles"},"Static Roles"),(0,s.kt)("p",null,'The database secrets engine supports the concept of "static roles", which are a 1-to-1 mapping of Vault Roles to usernames in a database. The current password for the database user is stored and automatically rotated by Vault on a configurable period of time. This is in contrast to dynamic secrets, where a unique username and password pair are generated with each credential request. When credentials are requested for the Role, Vault returns the current password for the configured database user, allowing anyone with the proper Vault policies to have access to the user account in the database.- Database user credentials rotation'),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Database root credentials rotation")),(0,s.kt)("p",null,"Vault's ",(0,s.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/secrets/databases/index.html"},"database secrets engine")," provides a centralized workflow for managing credentials for various database systems. By leveraging this, every service instance gets a unique set of database credentials instead of sharing one. Having those credentials tied directly to each service instance and live only for the life of the service, any abnormal access pattern can be mapped to a specific service instance and its credential can be revoked immediately.\nThis reduces the manual tasks performed by the database administrator and makes the database access more efficient and secure."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"image",src:a(679933).Z,width:"870",height:"327"}),"\n",(0,s.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/vault/database-root-rotation"},"https://learn.hashicorp.com/tutorials/vault/database-root-rotation")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/vault/database-secrets"},"https://learn.hashicorp.com/tutorials/vault/database-secrets")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/secrets/databases"},"https://www.vaultproject.io/docs/secrets/databases")),(0,s.kt)("h2",{id:"audit-devices"},"Audit Devices"),(0,s.kt)("p",null,"Audit devices are the components in Vault that keep a detailed log of all requests and response to Vault. Because every operation with Vault is an API request/response, the audit log containsevery authenticatedinteraction with Vault, including errors.\nMultiple audit devices can be enabled and Vault will send the audit logs to both. This allows you to not only have a redundant copy, but also a second copy in case the first is tampered with."),(0,s.kt)("h2",{id:"questions"},"Questions"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"How to delete credentials from hashicorp vault and database when pod terminates? (how to tie the credentials lifecyle to a pod)"),(0,s.kt)("li",{parentName:"ul"},"How applications will refresh the credentials when the credentials expire? - boto3, python, php"),(0,s.kt)("li",{parentName:"ul"},"How to give specific username (or some prefix for a username) for a database credentials (because we will exclude this user from audit logs)"),(0,s.kt)("li",{parentName:"ul"},"Give all pod same credentials"),(0,s.kt)("li",{parentName:"ul"},"Mount vault credentials to a specific location"),(0,s.kt)("li",{parentName:"ul"},"How to do disaster recovery"),(0,s.kt)("li",{parentName:"ul"},"Vault rotate master passwords and send emails"),(0,s.kt)("li",{parentName:"ul"},"Proxy to a master password like api keys")),(0,s.kt)("h2",{id:"steps"},"Steps"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Enable KV Engine")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Add ACL"))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'path "prod*" {\n    capabilities = ["read"]\n}\n')),(0,s.kt)("ol",{start:3},(0,s.kt)("li",{parentName:"ol"},"Create role\n",(0,s.kt)("a",{parentName:"li",href:"https://www.vaultproject.io/docs/what-is-vault"},"https://www.vaultproject.io/docs/what-is-vault"))),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/vault"},"https://github.com/hashicorp/vault")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/internals/architecture"},"https://www.vaultproject.io/docs/internals/architecture")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/vault"},"https://learn.hashicorp.com/vault")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://blog.container-solutions.com/secret-sprawl-and-the-challenges-of-modern-enterprise-security"},"https://blog.container-solutions.com/secret-sprawl-and-the-challenges-of-modern-enterprise-security")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.hashicorp.com/blog/dynamic-database-credentials-with-vault-and-kubernetes"},"https://www.hashicorp.com/blog/dynamic-database-credentials-with-vault-and-kubernetes"),"\n",(0,s.kt)("a",{parentName:"p",href:"https://www.youtube.com/playlist?list=PLHq1uqvAteVtq-NRX3yd1ziA_wJSBu3Oj"},"Kubernetes Secret Management guide beginners using Vault"),"\n",(0,s.kt)("img",{alt:"image",src:a(213083).Z,width:"612",height:"344"})),(0,s.kt)("h2",{id:"comparision"},"Comparision"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.cncf.io/announcements/2021/02/23/cncf-provides-insights-into-secrets-management-tools-with-latest-end-user-technology-radar"},"https://www.cncf.io/announcements/2021/02/23/cncf-provides-insights-into-secrets-management-tools-with-latest-end-user-technology-radar")))}d.isMDXComponent=!0},250824:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image1-e205d0c4950381bc1789ba0fb11917af.jpg"},24330:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image2-696e78ebc8cf0afcda5aadbebec9a80d.jpg"},590299:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image3-741ef6ab8c3b1830898be626b6d0086b.jpg"},818231:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image4-7788dfa74a2e044718634e7a9ffb5802.jpg"},808426:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image5-32613d1e31045bc3377e6bcf8f4c2af5.jpg"},467498:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image6-da88dd37f9b09f03ad810211e84b7ec6.jpg"},679933:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image7-87e3624aca1b8cd1025191b71e1d4ad0.jpg"},213083:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Vault-image8-8eb304019dd67750b57acaabb17ed411.jpg"}}]);