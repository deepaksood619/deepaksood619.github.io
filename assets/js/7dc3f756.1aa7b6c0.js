"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[84500],{867502:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>h,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"databases/sql-databases/mysql/gh-ost","title":"Gh-ost (Ghost)","description":"If like 99 percent of MySQL DBAs you have faced implementing a change to a MySQL table while fearing the impact on production, then you should consider Gh-ost (GitHub Online Schema Migration). Gh-ost provides MySQL schema changes without blocking writes, without using triggers, and with the ability to pause and resume the migration!","source":"@site/docs/databases/sql-databases/mysql/gh-ost.md","sourceDirName":"databases/sql-databases/mysql","slug":"/databases/sql-databases/mysql/gh-ost","permalink":"/databases/sql-databases/mysql/gh-ost","draft":false,"unlisted":false,"editUrl":"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/databases/sql-databases/mysql/gh-ost.md","tags":[],"version":"current","lastUpdatedBy":"Deepak","lastUpdatedAt":1746073436000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Documentation","permalink":"/databases/sql-databases/mysql/documentation"},"next":{"title":"GTID Replication","permalink":"/databases/sql-databases/mysql/gtid-replication"}}');var n=s(474848),a=s(28453);const i={},r="Gh-ost (Ghost)",h={},l=[{value:"Gh-ost operation modes",id:"gh-ost-operation-modes",level:3},{value:"Gh-ost general flow",id:"gh-ost-general-flow",level:3},{value:"Ghost Tables",id:"ghost-tables",level:3},{value:"Commands",id:"commands",level:2},{value:"Links",id:"links",level:2}];function c(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"gh-ost-ghost",children:"Gh-ost (Ghost)"})}),"\n",(0,n.jsxs)(t.p,{children:["If like 99 percent of MySQL DBAs you have faced implementing a change to a MySQL table while fearing the impact on production, then you should consider ",(0,n.jsx)(t.a,{href:"https://github.com/github/gh-ost",children:"Gh-ost"})," (GitHub Online Schema Migration). Gh-ost provides MySQL schema changes without blocking writes, without using triggers, and with the ability to pause and resume the migration!"]}),"\n",(0,n.jsxs)(t.p,{children:["Why is this so important? Since MySQL 5.6 shipped with new ",(0,n.jsx)(t.a,{href:"https://dev.mysql.com/doc/refman/5.6/en/alter-table.html",children:"ALTER TABLE ... ALGORITHM=INPLACE"})," DDL (Data Definition Language) functionality, it became possible to modify a table without blocking writes for common operations such as adding an index (B-tree). However, there remain a few conditions where ",(0,n.jsx)(t.a,{href:"https://dev.mysql.com/doc/refman/5.7/en/innodb-create-index-overview.html#innodb-online-ddl-summary-grid",children:"writes (DML statements) are blocked"}),", most notably the addition of a ",(0,n.jsx)(t.code,{children:"FULLTEXT"})," index, the encryption of the tablespace, and the conversion of a column type."]}),"\n",(0,n.jsxs)(t.p,{children:["Other popular online schema change tools, such as Percona's ",(0,n.jsx)(t.a,{href:"https://www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html",children:"pt-online-schema-change"}),", work by implementing a set of three triggers (INSERT, UPDATE, andDELETE) on the master to keep a shadow copy table in sync with changes. This introduces a small performance penalty due to write amplification, but more significantly requires seven instances of metadata locks. These effectively stall DML (Data Manipulation Language) events."]}),"\n",(0,n.jsxs)(t.p,{children:["Since Gh-ost operates using the binary log, it is not susceptible to the ",(0,n.jsx)(t.a,{href:"https://github.com/github/gh-ost/blob/master/doc/why-triggerless",children:"trigger-based drawbacks"}),". Finally Gh-ost is able to effectively ",(0,n.jsx)(t.a,{href:"https://github.com/github/gh-ost/blob/master/doc/interactive-commands#examples",children:"throttle activity to zero events"}),", allowing you to pause the schema migration for a while if your server begins to struggle, and resume when the activity bubble moves on."]}),"\n",(0,n.jsxs)(t.p,{children:["So how does Gh-ost work? By default, Gh-ost connects to a replica (slave), identifies the master, and applies the migration on the master. It receives changes on a replica to the source table in ",(0,n.jsx)(t.a,{href:"https://dev.mysql.com/doc/en/binary-log-setting.html",children:"binlog_format=ROW"}),", parses the log, and converts these statements to be re-executed on the master's shadow table.It keeps track of the row counts on the replica and identifies when it is time to perform an atomic cutover (switch tables)."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"image",src:s(145194).A+"",width:"999",height:"447"})}),"\n",(0,n.jsx)(t.h3,{id:"gh-ost-operation-modes",children:"Gh-ost operation modes"}),"\n",(0,n.jsxs)(t.p,{children:["Gh-ost provides an alternative mode where you execute the migration directly on the master (whether it has slaves or not), read back the master's ",(0,n.jsx)(t.code,{children:"binlog_format=ROW"})," events, and then re-apply them to the shadow table."]}),"\n",(0,n.jsx)(t.p,{children:"A final option is available to run the migration only on the replica without impacting the master, so you can test or otherwise validate the migration."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"image",src:s(812533).A+"",width:"999",height:"418"})}),"\n",(0,n.jsx)(t.h3,{id:"gh-ost-general-flow",children:"Gh-ost general flow"}),"\n",(0,n.jsx)(t.p,{children:"Note that if your schema has foreign keys then Gh-ost may not operate cleanly, as this configuration is not supported."}),"\n",(0,n.jsx)(t.h3,{id:"ghost-tables",children:"Ghost Tables"}),"\n",(0,n.jsx)(t.p,{children:"A ghost table is a database table that is no longer in use but still takes up space. Ghost tables are often created during schema changes or data migrations"}),"\n",(0,n.jsx)(t.h2,{id:"commands",children:"Commands"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"wget https://github.com/github/gh-ost/releases/download/v1.1.0/gh-ost_1.1.0_amd64.deb\n\nsudo dpkg -i gh-ost_1.1.0_amd64.deb\n\nSHOW VARIABLES LIKE '%binlog_row_image%';\n# this should be full instead of minimal, In RDS no restart required for this change, it's a dynamic variable\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"nohup gh-ost \\\n--host=10.0.40.5 \\\n--user=username \\\n--password='password' \\\n--database=db_name \\\n--table=users \\\n--alter=\"ADD COLUMN enc_uid VARCHAR(225), ADD INDEX idx_enc_uid (enc_uid)\" \\\n--discard-foreign-keys \\\n--skip-foreign-key-checks \\\n--postpone-cut-over-flag-file=./ghost-postpone.flag \\\n--serve-socket-file=./ghost_migration.sock \\\n--initially-drop-ghost-table \\\n--replica-server-id=13 \\\n--chunk-size=1000 \\\n--allow-on-master \\\n--execute > gh-ost.log 2>&1 &\n\nnohup gh-ost\n--host=demo.com\n--user=root\n--password='test'\n--database=db_name\n--table=users\n--alter=\"ADD COLUMN enc_uid VARCHAR(225), ADD INDEX idx_enc_uid (enc_uid)\"\n--exact-rowcount\n--concurrent-rowcount\n--assume-rbr\n--discard-foreign-keys\n--skip-foreign-key-checks\n--postpone-cut-over-flag-file=./ghost-postpone.flag\n--serve-socket-file=./ghost_session.sock\n--chunk-size=1000\n--allow-on-master\n--execute gh-ost.log 2>&1 &\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-sql",children:"-- ghc table has progress information\nselect * from _users_ghc;\n-- gho table has actual data with new column\nselect * from _users_gho;\n\n-- cleanup if failure before restarting ghost command\ndrop table _users_ghc;\ndrop table _users_gho;\n"})}),"\n",(0,n.jsx)(t.h2,{id:"links",children:"Links"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://github.com/github/gh-ost",children:"https://github.com/github/gh-ost"})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://www.infoworld.com/article/3241730/top-5-open-source-tools-for-mysql-administrators.html",children:"https://www.infoworld.com/article/3241730/top-5-open-source-tools-for-mysql-administrators.html"})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://www.mydbops.com/blog/gh-ost-for-mysql-schema-change",children:"GH-OST for MySQL Schema Change."})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://browntape.com/how-we-altered-a-mysql-table-with-50m-rows-without-downtime-with-gh-ost/",children:"How we Altered a MySQL Table with 50 Million Rows without Downtime using gh-ost - Browntape"})}),"\n",(0,n.jsxs)(t.p,{children:["Alternatives - ",(0,n.jsx)(t.a,{href:"https://github.com/cashapp/spirit",children:"GitHub - cashapp/spirit: Online Schema Change Tool for MySQL 8.0+"})]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"https://dnisha.github.io/mynotes/Production-grade-MYSQL-DBA/Alter-Schema-With-gh-ost",children:"Alter Schema With gh-ost"})})]})}function d(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},145194:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/MySQL_SQL-MySQL-Tools-image1-34a13b24e28b3c2583b6f00039a7c42c.jpg"},812533:(e,t,s)=>{s.d(t,{A:()=>o});const o=s.p+"assets/images/MySQL_SQL-MySQL-Tools-image2-2d51de2e5d138ad6f043f099c6dac670.jpg"},28453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>r});var o=s(296540);const n={},a=o.createContext(n);function i(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);