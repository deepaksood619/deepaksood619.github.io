"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[92446],{903708:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic","title":"Hands On: Requiring Encryption for Broker Traffic","description":"In the previous exercise, we enabled SSL on our Kafka brokers. Now we\'ll take it even further by creating the Kafka client truststore and importing the CA, configuring the Kafka client to encrypt data in transit using SSL, and requiring SSL for client-broker traffic.","source":"@site/docs/technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic.md","sourceDirName":"technologies/kafka/security","slug":"/technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic","permalink":"/technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic","draft":false,"unlisted":false,"editUrl":"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic.md","tags":[],"version":"current","lastUpdatedBy":"Deepak Sood","lastUpdatedAt":1769339984000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Hands On: Setting Up Encryption","permalink":"/technologies/kafka/security/07-hands-on-setting-up-encryption"},"next":{"title":"Securing ZooKeeper","permalink":"/technologies/kafka/security/09-securing-zookeeper"}}');var o=t(474848),s=t(28453);const i={},a="Hands On: Requiring Encryption for Broker Traffic",c={},l=[];function d(e){const n={code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"hands-on-requiring-encryption-for-broker-traffic",children:"Hands On: Requiring Encryption for Broker Traffic"})}),"\n",(0,o.jsx)(n.p,{children:"In the previous exercise, we enabled SSL on our Kafka brokers. Now we'll take it even further by creating the Kafka client truststore and importing the CA, configuring the Kafka client to encrypt data in transit using SSL, and requiring SSL for client-broker traffic."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["If you didn't complete the previous exercise, you can easily set up your environment by running the\xa0",(0,o.jsx)(n.code,{children:"mod2-init.sh"}),"\xa0inside the\xa0",(0,o.jsx)(n.code,{children:"scripts"}),"\xa0folder:"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"./home/training/learn-kafka-courses/fund-kafka-security/scripts/mod2-init.sh"})}),"\n",(0,o.jsx)(n.p,{children:"This will load in the correct docker-compose file as well as create the certificates and save all the credentials."}),"\n",(0,o.jsxs)(n.ol,{start:"2",children:["\n",(0,o.jsx)(n.li,{children:"Start the Docker containers by changing to the\xa0fund-kafka-security\xa0directory and running"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"docker-compose:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd fund-kafka-security\n\ndocker-compose up -d\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsx)(n.li,{children:"The first thing we are going to do is create a new topic:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-topics \\\n    --bootstrap-server localhost:19092 \\\n    --create \\\n    --topic test-topic \\\n    --replica-assignment 101:102:103\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"4",children:["\n",(0,o.jsx)(n.li,{children:"Now we need to monitor our network traffic while also producing so we can see and verify that our connection is encrypted. First, we'll set up the monitoring by downloading and running a netshoot Docker image:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it --net container:kafka-1  \\\n    nicolaka/netshoot  \\\n    tcpdump -c 40 -X port 19092 or port 19093\n"})}),"\n",(0,o.jsx)(n.p,{children:"Once that image has been downloaded and started you should see an output similar to the one in the video."}),"\n",(0,o.jsxs)(n.ol,{start:"5",children:["\n",(0,o.jsx)(n.li,{children:"Next, we'll open a new terminal window and run our console producer:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-console-producer \\\n    --bootstrap-server localhost:19092 \\\n    --topic test-topic\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then produce a message:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"Kafka Rocks!"})}),"\n",(0,o.jsx)(n.p,{children:"Exit the console producer by typing Ctrl-D."}),"\n",(0,o.jsx)(n.p,{children:'If we head back over to our monitoring terminal we can clearly read both the topic that we wrote to as well as the message "Kafka Rocks" in plaintext.'}),"\n",(0,o.jsxs)(n.ol,{start:"6",children:["\n",(0,o.jsx)(n.li,{children:"Let's go back to the terminal where we were producing our messages and create the client truststore and import the CA certificate:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"keytool -keystore /home/training/learn-kafka-courses/fund-kafka-security/client-creds/kafka.client.truststore.pkcs12 \\\n    -alias CARoot \\\n    -import \\\n    -file /home/training/learn-kafka-courses/fund-kafka-security/ca.crt \\\n    -storepass confluent  \\\n    -noprompt \\\n    -storetype PKCS12\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"7",children:["\n",(0,o.jsx)(n.li,{children:"This time when we run the console producer, we'll use the SSL port to produce the messages:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-console-producer \\\n    --bootstrap-server localhost:19093 \\\n    --topic test-topic\n"})}),"\n",(0,o.jsx)(n.p,{children:"Almost immediately we start to see errors. Any idea why? Consider the command above. While we provided the SSL port, we also needed to provide the configuration settings. We can see what these are by looking at the\xa0client-ssl.properties\xa0file:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"cat /home/training/learn-kafka-courses/fund-kafka-security/client-creds/client-ssl.properties"})}),"\n",(0,o.jsx)(n.p,{children:"Let's try that command again, but this time provide the configuration file."}),"\n",(0,o.jsx)(n.p,{children:"First, we'll start our monitoring again:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it --net container:kafka-1  \\\n    nicolaka/netshoot  \\\n    tcpdump -c 40 -X port 19092 or port 19093\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then we'll run the same command, but with the location of the\xa0client-ssl.properties\xa0file:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-console-producer \\\n    --bootstrap-server localhost:19093 \\\n    --topic test-topic \\\n    --producer.config /home/training/learn-kafka-courses/fund-kafka-security/client-creds/client-ssl.properties\n"})}),"\n",(0,o.jsx)(n.p,{children:"Fantastic, no error messages. Let's send a message:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"Kafka Rocks!"})}),"\n",(0,o.jsx)(n.p,{children:"Then close the producer by typing Ctrl-D."}),"\n",(0,o.jsx)(n.p,{children:"This time when we look at the output we can see that the message was encrypted and is no longer in plaintext."}),"\n",(0,o.jsxs)(n.ol,{start:"8",children:["\n",(0,o.jsxs)(n.li,{children:["Now that we know that the encryption is working, let's disable the plaintext listener. Open the\xa0docker-compose.yml\xa0file and scroll to the\xa0kafka-1\xa0broker environment. We are looking for the\xa0",(0,o.jsx)(n.code,{children:"KAFKA_LISTENERS"}),"\xa0and\xa0",(0,o.jsx)(n.code,{children:"KAFKA_ADVERTISED_LISTENERS"}),"\xa0lines."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Go ahead and delete the ",(0,o.jsx)(n.code,{children:"PLAINTEXT"})," sections from the line, and then do it for our other two brokers as well."]}),"\n",(0,o.jsxs)(n.p,{children:["You can also delete it from the\xa0",(0,o.jsx)(n.code,{children:"KAFKA_LISTENER_SECURITY_PROTOCOL_MAP"}),"\xa0section."]}),"\n",(0,o.jsxs)(n.ol,{start:"9",children:["\n",(0,o.jsx)(n.li,{children:"Now recreate our brokers by typing:"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"docker-compose up -d"})}),"\n",(0,o.jsxs)(n.ol,{start:"10",children:["\n",(0,o.jsx)(n.li,{children:"After things have come back up, we'll go ahead and try to retrieve the messages we sent to our\xa0test-topic:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-console-consumer \\\n    --bootstrap-server localhost:19092 \\\n    --topic test-topic \\\n    --from-beginning\n"})}),"\n",(0,o.jsx)(n.p,{children:"After you see the errors close the connection with Ctrl-C."}),"\n",(0,o.jsx)(n.p,{children:"Similar to what we previously saw, the consumer was attempting to use the plaintext listener to retrieve the messages."}),"\n",(0,o.jsxs)(n.ol,{start:"11",children:["\n",(0,o.jsx)(n.li,{children:"If we now try to retrieve the messages from the SSL port and provide the configuration file we'll actually see our messages:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"kafka-console-consumer \\\n    --bootstrap-server localhost:19093 \\\n    --topic test-topic \\\n    --consumer.config /home/training/learn-kafka-courses/fund-kafka-security/client-creds/client-ssl.properties \\\n    --from-beginning\n"})}),"\n",(0,o.jsx)(n.p,{children:"Press Ctrl-C to stop the consumer."}),"\n",(0,o.jsx)(n.p,{children:"Congratulations! You successfully configured Kafka clients to encrypt traffic between themselves and your Kafka brokers (with plaintext listeners disabled)."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(296540);const o={},s=r.createContext(o);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);