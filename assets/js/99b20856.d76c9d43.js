"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[19712],{711526:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"databases/sql-databases/mysql/connection-handling","title":"Connection Handling","description":"The MySQL Server (mysqld) executes as a single OS process, with multiple threads executing concurrent activities. MySQL does not have its own thread implementation, but relies on the thread implementation of the underlying OS. When a user connects to the database a user thread is created inside mysqld and this user thread executes user queries, sending results back to the user, until the user disconnects.","source":"@site/docs/databases/sql-databases/mysql/connection-handling.md","sourceDirName":"databases/sql-databases/mysql","slug":"/databases/sql-databases/mysql/connection-handling","permalink":"/databases/sql-databases/mysql/connection-handling","draft":false,"unlisted":false,"editUrl":"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/databases/sql-databases/mysql/connection-handling.md","tags":[],"version":"current","lastUpdatedBy":"Deepak","lastUpdatedAt":1713373243000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Backup Types","permalink":"/databases/sql-databases/mysql/backup-types"},"next":{"title":"Documentation","permalink":"/databases/sql-databases/mysql/documentation"}}');var a=t(474848),i=t(28453);const o={},c="Connection Handling",r={},l=[{value:"Connect and Disconnect",id:"connect-and-disconnect",level:2},{value:"Clients",id:"clients",level:2},{value:"Connection Requests",id:"connection-requests",level:2},{value:"Receiver Thread",id:"receiver-thread",level:2},{value:"Thread Cache",id:"thread-cache",level:2},{value:"User Thread",id:"user-thread",level:2},{value:"THD",id:"thd",level:2},{value:"Short Lived Connections",id:"short-lived-connections",level:2},{value:"Long Lived Connections",id:"long-lived-connections",level:2},{value:"What limits threads concurrency",id:"what-limits-threads-concurrency",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"connection-handling",children:"Connection Handling"})}),"\n",(0,a.jsx)(n.p,{children:"The MySQL Server (mysqld) executes as a single OS process, with multiple threads executing concurrent activities. MySQL does not have its own thread implementation, but relies on the thread implementation of the underlying OS. When a user connects to the database a user thread is created inside mysqld and this user thread executes user queries, sending results back to the user, until the user disconnects."}),"\n",(0,a.jsx)(n.p,{children:"When more and more users connect to the database, more and more user threads execute in parallel. As long as all user threads execute as if they are alone we can say that the system (MySQL) scales well. But at some point we reach a limit and adding more user threads will not be useful or efficient."}),"\n",(0,a.jsx)(n.h2,{id:"connect-and-disconnect",children:"Connect and Disconnect"}),"\n",(0,a.jsx)(n.p,{children:"Connectionscorrespond toSessionsin SQL standard terminology. A client connects to the MySQL Server and stays connected until it does a disconnect. Figure 1 illustrates what happens when a MySQL Client connects to a MySQL Server."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"image",src:t(205193).A+"",width:"1024",height:"427"})}),"\n",(0,a.jsx)(n.h2,{id:"clients",children:"Clients"}),"\n",(0,a.jsxs)(n.p,{children:["A MySQL Client is a command line tool or an application that talks to the MySQL Server over the MySQL Client-Server protocol using the ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/c-api-implementations.html",children:"libmysqlclient"})," library or some of the many MySQL connectors. A single multi-threaded client can open many connections to the server, but for simplicity we here sayone client opens one connectionto the server."]}),"\n",(0,a.jsx)(n.h2,{id:"connection-requests",children:"Connection Requests"}),"\n",(0,a.jsx)(n.p,{children:"The MySQL Clients sendconnection requeststo the MySQL Server. A connection request is simply a TCP-IP connect message sent to port 3306 on the server host machine."}),"\n",(0,a.jsx)(n.h2,{id:"receiver-thread",children:"Receiver Thread"}),"\n",(0,a.jsx)(n.p,{children:"Incoming connection requests are queued and then processed by thereceiver threadone by one. The only job of the receiver thread is to create auser thread, further processing is done by the user thread."}),"\n",(0,a.jsx)(n.h2,{id:"thread-cache",children:"Thread Cache"}),"\n",(0,a.jsxs)(n.p,{children:['The receiver thread will either create a new OS thread or reuse an existing "free" OS thread if found in the thread cache. The thread cache used to be important for connect speed when OS threads were costly to create. Nowadays creating an OS thread is relatively cheap and the thread cache can perhaps be said to be legacy. The ',(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_thread_cache_size",children:"thread_cache_size"})," default value is calculated as 8 + (max_connections / 100) and is rarely changed. It might make sense to try increasing the thread cache in cases where number of connections fluctuates between having very few connections and having many connections."]}),"\n",(0,a.jsx)(n.h2,{id:"user-thread",children:"User Thread"}),"\n",(0,a.jsxs)(n.p,{children:["It is the user thread that handles the ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PROTOCOL.html",children:"client-server protocol"}),", e.g. sends back the initial handshake packet. Thisuser threadwill allocate and initialize the corresponding THD, and then continue with capability negotiation and authentication. In this process the user credentials are stored in the THD'ssecurity context. If everything goes well in the ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_connection_phase.html",children:"connection phase"}),", the user thread will enter the ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_command_phase.html",children:"command phase"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"thd",children:"THD"}),"\n",(0,a.jsxs)(n.p,{children:["The connection is represented by a data structure called the THD which is created when the connection is established and deleted when the connection is dropped. There is always a one-to-one correspondence between a user connection and a THD, i.e. THDs are not reused across connections. The size of the THD is ~10K and its definition is found in ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/dev/mysql-server/latest/classTHD.html",children:"sql_class.h"}),". The THD is a large data structure which is used to keep track of various aspects of execution state. Memory rooted in the THD will grow significantly during query execution, but exactly how much it grows will depend upon the query. For memory planning purposes we recommend to plan for ~10MB per connection on average."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"image",src:t(831486).A+"",width:"1024",height:"196"})}),"\n",(0,a.jsx)(n.p,{children:"Figure 2 illustrates the command phase. Here, the client sends queries to the server and get results back in several rounds. In general, a sequence of statements can be enclosed by a start transaction and a commit/rollback. In this case there is a need to keep track of thetransaction context. In auto-commit mode, each statement will be executed as a transaction (each statement constitutes the full transaction context). In addition there is thesession context, i.e. the session can hold session variables, user variables, and temporary tables. Thus, as long as the context is relevant for executing queries, all queries on a connection must use the same THD."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"image",src:t(186267).A+"",width:"1024",height:"235"})}),"\n",(0,a.jsxs)(n.p,{children:["Figure 3 illustrates what happens when a MySQL Client disconnects from a MySQL Server. The Client sends a ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_com_quit.html",children:"COM_QUIT"}),' command which causes the server to close the socket. A disconnect can also happen when either side closes its end of the socket. Upon a disconnect the user thread will clean up, deallocate the THD, and finally put itself in the Thread Cache as "suspended" if there are free slots. If there are no free slots, the user thread will be "terminated".']}),"\n",(0,a.jsx)(n.h2,{id:"short-lived-connections",children:"Short Lived Connections"}),"\n",(0,a.jsx)(n.p,{children:"A short lived connection is a connection that is only open for a short period of time. This is typically the case for PHP applications, the client opens a connection, executes a simple query, and then closes the connection. Due to its architecture, MySQL is really good at accepting new connections at a high speed, up to 80,000 connects/disconnects per second"}),"\n",(0,a.jsx)(n.h2,{id:"long-lived-connections",children:"Long Lived Connections"}),"\n",(0,a.jsx)(n.p,{children:'A long lived connection is a connection that is open "indefinitely". For example one might have a Web server or an Application server opening many connections to the MySQL server and keeping them open until the client (Web/Application server) is stopped, perhaps for months.'}),"\n",(0,a.jsx)(n.h2,{id:"what-limits-threads-concurrency",children:"What limits threads concurrency"}),"\n",(0,a.jsx)(n.p,{children:"A thread will happily execute instructions until it needs to wait for something or until it has used its timeshare as decided by the OS scheduler. There are three things a thread might need to wait for: A mutex, a database lock, or IO."}),"\n",(0,a.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"MySQL is very good at handling many clients connecting and disconnecting to the database at a high frequency, up to 80 thousand connect and disconnects per second"}),"\n",(0,a.jsx)(n.li,{children:"MySQL scales well on multi-core CPUs and can deliver up to 2 million primary key look-ups per second on 48 CPU cores."}),"\n",(0,a.jsx)(n.li,{children:"Rule of thumb: Max number of connections = 4 times available CPU cores"}),"\n",(0,a.jsx)(n.li,{children:"Efficient use of connections will depend upon user load, useful number of user connections can even be lower than number of CPU cores when the bottleneck is somewhere else than on the threading"}),"\n",(0,a.jsx)(n.li,{children:"Check out your own load by doubling the number of connections until TPS no longer increases and latency starts to increase"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://mysqlserverteam.com/mysql-connection-handling-and-scaling",children:"https://mysqlserverteam.com/mysql-connection-handling-and-scaling"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},205193:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/MySQL_Connection-Handling-image1-150ec170ba44b39ccb9e3c7d1c654f22.jpg"},831486:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/MySQL_Connection-Handling-image2-90993171bbf303138e081431ceb7e45c.jpg"},186267:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/MySQL_Connection-Handling-image3-1423d513eacee7e70747a80cd0d7d067.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(296540);const a={},i=s.createContext(a);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);