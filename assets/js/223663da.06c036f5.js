"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[35864],{140832:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"technologies/kafka/security/07-hands-on-setting-up-encryption","title":"Hands On: Setting Up Encryption","description":"In this exercise, we\u2019ll show you how to put a lot of the things we\u2019ve talked about so far into practice. First, we\u2019ll set up our Kafka environment to use SSL/TLS to encrypt our data in motion by creating certificates, and then we\'ll configure our brokers to use SSL.","source":"@site/docs/technologies/kafka/security/07-hands-on-setting-up-encryption.md","sourceDirName":"technologies/kafka/security","slug":"/technologies/kafka/security/07-hands-on-setting-up-encryption","permalink":"/technologies/kafka/security/07-hands-on-setting-up-encryption","draft":false,"unlisted":false,"editUrl":"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/technologies/kafka/security/07-hands-on-setting-up-encryption.md","tags":[],"version":"current","lastUpdatedBy":"Deepak Sood","lastUpdatedAt":1769433622000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Encryption","permalink":"/technologies/kafka/security/06-encryption"},"next":{"title":"Hands On: Requiring Encryption for Broker Traffic","permalink":"/technologies/kafka/security/08-hands-on-requiring-encryption-for-broker-traffic"}}');var s=a(474848),r=a(28453);const o={},i="Hands On: Setting Up Encryption",c={},l=[];function k(e){const n={a:"a",code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"hands-on-setting-up-encryption",children:"Hands On: Setting Up Encryption"})}),"\n",(0,s.jsx)(n.p,{children:"In this exercise, we\u2019ll show you how to put a lot of the things we\u2019ve talked about so far into practice. First, we\u2019ll set up our Kafka environment to use SSL/TLS to encrypt our data in motion by creating certificates, and then we'll configure our brokers to use SSL."}),"\n",(0,s.jsxs)(n.p,{children:["To follow along you\u2019ll need to clone the GitHub repository for this course, so head to\xa0",(0,s.jsx)(n.a,{href:"https://github.com/confluentinc/learn-kafka-courses",children:"https://github.com/confluentinc/learn-kafka-courses"}),"\xa0and clone the repo. The files for this course are located in the\xa0fund-kafka-security\xa0folder."]}),"\n",(0,s.jsx)(n.p,{children:"Before we start Kafka, there are a few changes we need to make to get things set up."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"First, let's take a look at the docker-compose file that has the instructions for Docker, but also our server configuration parameters."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This environment has three instances of ZooKeeper as well as three brokers. With this configuration we have two listeners configured, the default PLAINTEXT listener and the internal BROKER listener. You can also see the advertised listeners that have been configured on the next line."}),"\n",(0,s.jsx)(n.p,{children:"Let's go ahead and comment both those lines out, and remove the comment from the next two lines adding in the SSL listener. We\u2019ll want to do that for each broker:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"Broker 1:\n      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:19092,BROKER://0.0.0.0:9092\n      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:19092,BROKER://kafka-1:9092\n      #KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:19092,SSL://0.0.0.0:19093,BROKER://0.0.0.0:9092\n      #KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:19092,SSL://localhost:19093,BROKER://kafka-1:9092\n\nBroker 2:\n      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,BROKER://0.0.0.0:9092\n      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:29092,BROKER://kafka-2:9092\n      #KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,SSL://0.0.0.0:29093,BROKER://0.0.0.0:9092\n      #KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:29092,SSL://localhost:29093,BROKER://kafka-2:9092\n\nBroker 3:\n      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:39092,BROKER://0.0.0.0:9092\n      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:39092,BROKER://kafka-3:9092\n      #KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:39092,SSL://0.0.0.0:39093,BROKER://0.0.0.0:9092\n      #KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:39092,SSL://localhost:39093,BROKER://kafka-3:9092\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Notice we also have\xa0",(0,s.jsx)(n.code,{children:"KAFKA_LISTENER_SECURITY_PROTOCOL_MAP"}),"\xa0set to accept SSL connections as well. This is the property that determines the communication protocol used by listeners."]}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Next, we'll create the certification authority key and certificate by running the following command in the terminal (in this exercise we are using a certificate that is self-signed; as mentioned in the previous modules if you are using a production environment we recommend using a trusted certificate authority (CA) rather than a self-signed certificate):"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl req -new -nodes \\\n   -x509 \\\n   -days 365 \\\n   -newkey rsa:2048 \\\n   -keyout /home/training/learn-kafka-courses/fund-kafka-security/ca.key \\\n   -out /home/training/learn-kafka-courses/fund-kafka-security/ca.crt \\\n   -config /home/training/learn-kafka-courses/fund-kafka-security/ca.cnf\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We are creating a new key and certificate that is valid for 365 days, uses the rsa:2048 encryption, and uses the values we\u2019ve stored in the\xa0",(0,s.jsx)(n.code,{children:"ca.cnf"}),"\xa0file on the machine. Feel free to take a look at that file if you are interested in the parameters used as it\u2019s created."]}),"\n",(0,s.jsxs)(n.p,{children:["You should see an output similar to the one on-screen as well as the two new files that appear in the\xa0",(0,s.jsx)(n.code,{children:"tls"}),"\xa0directory."]}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:["We now need to convert those files over to a\xa0",(0,s.jsx)(n.code,{children:".pem"}),"\xa0file:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cat /home/training/learn-kafka-courses/fund-kafka-security/ca.crt /home/training/learn-kafka-courses/fund-kafka-security/ca.key > /home/training/learn-kafka-courses/fund-kafka-security/ca.pem\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Create the server key and certificate by running the following command:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl req -new \\\n    -newkey rsa:2048 \\\n    -keyout /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.key \\\n    -out /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.csr \\\n    -config /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.cnf \\\n    -nodes\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"Then sign the certificate with the certificate authority:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl x509 -req \\\n    -days 3650 \\\n    -in /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.csr \\\n    -CA /home/training/learn-kafka-courses/fund-kafka-security/ca.crt \\\n    -CAkey /home/training/learn-kafka-courses/fund-kafka-security/ca.key \\\n    -CAcreateserial \\\n    -out /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.crt \\\n    -extfile /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.cnf \\\n    -extensions v3_req\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"6",children:["\n",(0,s.jsx)(n.li,{children:"We\u2019ll need to convert the server certificate over to the\xa0pkcs12\xa0format:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl pkcs12 -export \\\n    -in /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.crt \\\n    -inkey /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.key \\\n    -chain \\\n    -CAfile /home/training/learn-kafka-courses/fund-kafka-security/ca.pem \\\n    -name kafka-1 \\\n    -out /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.p12 \\\n    -password pass:confluent\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"7",children:["\n",(0,s.jsx)(n.li,{children:"Now, we need to create the broker keystore and import the certificate:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"keytool -importkeystore \\\n    -deststorepass confluent \\\n    -destkeystore /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka.kafka-1.keystore.pkcs12 \\\n    -srckeystore /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1.p12 \\\n    -deststoretype PKCS12  \\\n    -srcstoretype PKCS12 \\\n    -noprompt \\\n    -srcstorepass confluent\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"8",children:["\n",(0,s.jsx)(n.li,{children:"Verify the kafka-1 broker keystore:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"keytool -list -v \\\n    -keystore /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka.kafka-1.keystore.pkcs12 \\\n    -storepass confluent\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"9",children:["\n",(0,s.jsx)(n.li,{children:"Last, we'll need to save the credentials:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo tee /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1_sslkey_creds << EOF >/dev/null\nconfluent\nEOF\n\nsudo tee /home/training/learn-kafka-courses/fund-kafka-security/kafka-1-creds/kafka-1_keystore_creds << EOF >/dev/null\nconfluent\nEOF\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"10",children:["\n",(0,s.jsx)(n.li,{children:"While we could do this for each of our brokers, we\u2019ve simplified the steps by scripting all we just did for the two remaining brokers. Feel free to take a look at the file if you're curious; you can redo the same steps for brokers 2 and 3, or just run the command:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo /home/training/learn-kafka-courses/fund-kafka-security/scripts/keystore-create-kafka-2-3.sh\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"11",children:["\n",(0,s.jsx)(n.li,{children:"These saved credentials are needed for the broker\xa0ssl.keystore.credentials\xa0and\xa0ssl.key.credentials\xa0broker configuration parameters. These parameters are set for our lab environment brokers in the environment section of the\xa0docker-compose.yml\xa0file:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-1_keystore_creds\nKAFKA_SSL_KEY_CREDENTIALS: kafka-1_sslkey_creds\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"12",children:["\n",(0,s.jsx)(n.li,{children:"Now we\u2019ll change to the\xa0fund-kafka-security\xa0directory and start our Docker instance:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd fund-kafka-security\n\ndocker-compose up -d\n"})}),"\n",(0,s.jsx)(n.p,{children:"And make sure that everything is up and running:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"docker-compose ps"})}),"\n",(0,s.jsxs)(n.ol,{start:"13",children:["\n",(0,s.jsx)(n.li,{children:"Then we\u2019ll open an SSL connection with our kafka-1 broker to verify that things are working:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl s_client -connect localhost:19093 -tls1_3 -showcerts\n"})}),"\n",(0,s.jsx)(n.p,{children:"Close the connection with Ctrl+C."}),"\n",(0,s.jsxs)(n.ol,{start:"14",children:["\n",(0,s.jsx)(n.li,{children:"We'll also open the connection with brokers 2 and 3 just to make sure that"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"everything is running as expected:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"openssl s_client -connect localhost:29093 -tls1_3 -showcerts\n\nopenssl s_client -connect localhost:39093 -tls1_3 -showcerts\n"})}),"\n",(0,s.jsx)(n.p,{children:"Congratulations! You've successfully added an SSL listener to your brokers, created a CA, created broker keystores, imported the CA into your broker keystore, and configured the SSL properties."}),"\n",(0,s.jsx)(n.p,{children:"In the next exercise, we'll create the Kafka client truststore and import the CA, configure the Kafka client to encrypt data in transit, and require SSL for client-to-broker traffic."})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(k,{...e})}):k(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>i});var t=a(296540);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);