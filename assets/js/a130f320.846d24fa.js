"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[32191],{543426:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"databases/data-warehouses/bigquery/queries","title":"Queries","description":"Data scanning analysis","source":"@site/docs/databases/data-warehouses/bigquery/queries.md","sourceDirName":"databases/data-warehouses/bigquery","slug":"/databases/data-warehouses/bigquery/queries","permalink":"/databases/data-warehouses/bigquery/queries","draft":false,"unlisted":false,"editUrl":"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/databases/data-warehouses/bigquery/queries.md","tags":[],"version":"current","lastUpdatedBy":"Deepak","lastUpdatedAt":1737177199000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Optimizations","permalink":"/databases/data-warehouses/bigquery/optimizations"},"next":{"title":"ClickHouse","permalink":"/databases/data-warehouses/clickhouse"}}');var s=a(474848),r=a(28453);const i={},d="Queries",o={},l=[{value:"Data scanning analysis",id:"data-scanning-analysis",level:3},{value:"SQL",id:"sql",level:3},{value:"Commands",id:"commands",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"queries",children:"Queries"})}),"\n",(0,s.jsx)(n.h3,{id:"data-scanning-analysis",children:"Data scanning analysis"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- find how much data is being scanned by month\nSELECT\n  FORMAT_TIMESTAMP('%Y-%m', creation_time) AS month,\n  ROUND(SUM(total_bytes_processed) / POW(2, 30), 2) AS total_gb_scanned\nFROM\n  `region-asia-south1.INFORMATION_SCHEMA.JOBS_BY_PROJECT`\nWHERE\n  state = 'DONE'\n  AND job_type = 'QUERY'\n  AND creation_time BETWEEN TIMESTAMP('2024-01-01') AND CURRENT_TIMESTAMP()\nGROUP BY\n  month\nORDER BY\n  month;\n\n-- find how much data is being scanned by day\nSELECT\n  FORMAT_TIMESTAMP('%Y-%m-%d', creation_time) AS day,\n  ROUND(SUM(total_bytes_processed) / POW(2, 30), 2) AS total_gb_scanned\nFROM\n  `region-REGION_NAME.INFORMATION_SCHEMA.JOBS_BY_PROJECT`\nWHERE\n  state = 'DONE'\n  AND job_type = 'QUERY'\n  AND creation_time BETWEEN TIMESTAMP('2025-01-01') AND CURRENT_TIMESTAMP()\nGROUP BY\n  day\nORDER BY\n  day;\n\n-- find the top queries that scanned the most amount of data\nSELECT\n  query,\n  user_email,\n  COUNT(*) AS query_count,\n  ROUND(SUM(total_bytes_processed) / POW(2, 30), 2) AS total_gb_scanned,\n  ROUND(SUM(total_bytes_processed) / COUNT(*) / POW(2, 30), 2) AS avg_gb_scanned_per_query,\n  ARRAY_AGG(FORMAT_TIMESTAMP('%Y-%m-%d %H:%M:%S', creation_time) ORDER BY creation_time) AS query_run_timestamps\nFROM\n  `region-asia-south1.INFORMATION_SCHEMA.JOBS_BY_PROJECT`\nWHERE\n  state = 'DONE'\n  AND job_type = 'QUERY'\n  AND creation_time BETWEEN TIMESTAMP('2025-01-01') AND CURRENT_TIMESTAMP()\nGROUP BY\n  query,\n  user_email\nORDER BY\n  total_gb_scanned DESC\nLIMIT 10;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"sql",children:"SQL"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- standardSQL\nSELECT\n    departure_airport,\n    arrival_airport,\n    COUNT(1) AS num_flights\nFROM\n    `bigquery-samples.airline_ontime_data.flights`\nGROUP BY\n    departure_airport,\n    arrival_airport\nORDER BY\n    num_flights DESC\nLIMIT\n    10\n\n-- standardSQL\nSELECT\n    departure_delay,\n    COUNT(1) AS num_flights,\n    APPROX_QUANTILES(arrival_delay, 5) AS arrival_delay_quantiles\nFROM\n    `bigquery-samples.airline_ontime_data.flights`\nGROUP BY\n    departure_delay\nHAVING\n    num_flights > 100\nORDER BY\n    departure_delay ASC\n"})}),"\n",(0,s.jsx)(n.h2,{id:"commands",children:"Commands"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from google.cloud import bigquery\nclient = bigquery.Client()\ndataset_ref = client.dataset("hacker_news", project="bigquery-public-data")\ndataset_ref = client.dataset("chicago_crime", project="bigquery-public-data")\ndataset = client.get_dataset(dataset_ref)\n'})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>d});var t=a(296540);const s={},r=t.createContext(s);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);