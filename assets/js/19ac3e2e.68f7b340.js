"use strict";(self.webpackChunkdeep_notes=self.webpackChunkdeep_notes||[]).push([[97282],{983159:(e,o,a)=>{a.r(o),a.d(o,{assets:()=>i,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var n=a(785893),t=a(511151);const l={},s="Memory Management",r={id:"python/advanced/memory-management",title:"Memory Management",description:"Everything in Python is an object. Some objects can hold other objects, such as lists, tuples, dicts, classes, etc. Because of dynamic Python's nature, such approach requires a lot of small memory allocations. To speed-up memory operations and reduce fragmentation Python uses a special manager on top of the general-purpose allocator, called PyMalloc.",source:"@site/docs/python/advanced/memory-management.md",sourceDirName:"python/advanced",slug:"/python/advanced/memory-management",permalink:"/python/advanced/memory-management",draft:!1,unlisted:!1,editUrl:"https://github.com/deepaksood619/deepaksood619.github.io/tree/master/docs/python/advanced/memory-management.md",tags:[],version:"current",lastUpdatedAt:1705054005,formattedLastUpdatedAt:"Jan 12, 2024",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Idiomatic Python",permalink:"/python/advanced/idiomatic-python"},next:{title:"Mixin",permalink:"/python/advanced/mixin"}},i={},c=[{value:"Object allocation",id:"object-allocation",level:2},{value:"Small object allocation",id:"small-object-allocation",level:2},{value:"Block",id:"block",level:2},{value:"Pool",id:"pool",level:2},{value:"Arena",id:"arena",level:2},{value:"Memory deallocation",id:"memory-deallocation",level:2},{value:"Code",id:"code",level:2},{value:"Others",id:"others",level:2}];function d(e){const o={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.h1,{id:"memory-management",children:"Memory Management"}),"\n",(0,n.jsx)(o.p,{children:"Everything in Python is an object. Some objects can hold other objects, such as lists, tuples, dicts, classes, etc. Because of dynamic Python's nature, such approach requires a lot of small memory allocations. To speed-up memory operations and reduce fragmentation Python uses a special manager on top of the general-purpose allocator, called PyMalloc."}),"\n",(0,n.jsx)(o.p,{children:"We can depict the whole system as a set of hierarchical layers:"}),"\n",(0,n.jsx)(o.p,{children:(0,n.jsx)(o.img,{alt:"image",src:a(779441).Z+"",width:"886",height:"996"})}),"\n",(0,n.jsx)(o.h2,{id:"object-allocation",children:"Object allocation"}),"\n",(0,n.jsxs)(o.p,{children:["Methods and variables are created in ",(0,n.jsx)(o.strong,{children:"Stack memory"}),". A stack frame is created whenever methods and variables are created. These frames are destroyed automatically whenever methods are returned."]}),"\n",(0,n.jsxs)(o.p,{children:["Objects and instance variables are created in ",(0,n.jsx)(o.strong,{children:"Heap memory"}),". As soon as the variables and functions are returned, dead objects will be garbage collected."]}),"\n",(0,n.jsx)(o.h2,{id:"small-object-allocation",children:"Small object allocation"}),"\n",(0,n.jsx)(o.p,{children:"To reduce overhead for small objects (less than 512 bytes) Python sub-allocates big blocks of memory. Larger objects are routed to standard C allocator. Small object allocator uses three levels of abstraction -arena, pool, andblock."}),"\n",(0,n.jsx)(o.h2,{id:"block",children:"Block"}),"\n",(0,n.jsx)(o.p,{children:"Block is a chunk of memory of a certain size. Each block can keep only one Python object of a fixed size. The size of the block can vary from 8 to 512 bytes and be a multiple of eight (i.e., 8-byte alignment). For convenience, such blocks are grouped in 64 size classes."}),"\n",(0,n.jsx)(o.h2,{id:"pool",children:"Pool"}),"\n",(0,n.jsxs)(o.p,{children:["A collection of blocks of the same size is called a pool. Normally, the size of the pool is equal to the size of a ",(0,n.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Page_(computer_memory)",children:"memory page"}),", i.e., 4Kb. Limiting pool to the fixed size of blocks helps with fragmentation. If an object gets destroyed, the memory manager can fill this space with a new object of the same size."]}),"\n",(0,n.jsxs)(o.p,{children:["Pools of the same sized blocks are linked together using ",(0,n.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Doubly_linked_list",children:"doubly linked list"}),"(the nextpool and prevpool fields). The szidx field keeps the size class index, whereas ref.count keeps the number of used blocks. The are na index stores the number of an arena in which Pool was created."]}),"\n",(0,n.jsx)(o.p,{children:"Therefore, If a block is empty instead of an object, it stores an address of the next empty block. This trick saves a lot of memory and computation."}),"\n",(0,n.jsx)(o.p,{children:"Each pool has three states:"}),"\n",(0,n.jsxs)(o.ul,{children:["\n",(0,n.jsx)(o.li,{children:"used - partially used, neither empty nor full"}),"\n",(0,n.jsx)(o.li,{children:"full - all the pool's blocks are currently allocated"}),"\n",(0,n.jsx)(o.li,{children:"empty - all the pool's blocks are currently available for allocation"}),"\n"]}),"\n",(0,n.jsx)(o.p,{children:"In order to efficiently manage pools Python uses an additional array called used pools. It stores pointers to the pools grouped by class. As we already know, all pools of the same block size are linked together. To iterate over them, we just need to know the start of the list. If there are no pools of such size, then a new pool will be created on the first memory request."}),"\n",(0,n.jsx)(o.h2,{id:"arena",children:"Arena"}),"\n",(0,n.jsx)(o.p,{children:"The arena is a chunk of 256kB memory allocated on the heap, which provides memory for 64 pools."}),"\n",(0,n.jsxs)(o.p,{children:["All arenas are linked using ",(0,n.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/Doubly_linked_list",children:"doubly linked list"}),"(the next arena and prev arena fields), it helps to manage them. Then total pools and n free pools are storing information about currently available pools."]}),"\n",(0,n.jsx)(o.p,{children:"The free pools field points to the linked list of available pools."}),"\n",(0,n.jsx)(o.p,{children:"There is nothing complicated in the implementation of the arena. Think of it as a list of containers, which automatically allocates new memory for pools when needed."}),"\n",(0,n.jsx)(o.h2,{id:"memory-deallocation",children:"Memory deallocation"}),"\n",(0,n.jsx)(o.p,{children:"Python's small object manager rarely returns memory back to the Operating System."}),"\n",(0,n.jsx)(o.p,{children:"An arena gets fully released If and only if all the pools in it are empty. For example, it can happen when you use a lot of temporary objects in a short period of time."}),"\n",(0,n.jsx)(o.p,{children:"Speaking of long-running Python processes, they may hold a lot of unused memory because of this behavior."}),"\n",(0,n.jsx)(o.h2,{id:"code",children:"Code"}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",children:"import sys\n\nsys._debugmallocstats()\n"})}),"\n",(0,n.jsx)(o.p,{children:(0,n.jsx)(o.a,{href:"https://rushter.com/blog/python-memory-managment",children:"https://rushter.com/blog/python-memory-managment"})}),"\n",(0,n.jsx)(o.h2,{id:"others",children:"Others"}),"\n",(0,n.jsx)(o.p,{children:(0,n.jsx)(o.a,{href:"https://adamj.eu/tech/2019/09/19/working-around-memory-leaks-in-your-django-app",children:"https://adamj.eu/tech/2019/09/19/working-around-memory-leaks-in-your-django-app"})}),"\n",(0,n.jsx)(o.p,{children:(0,n.jsx)(o.a,{href:"https://www.honeybadger.io/blog/memory-management-in-python/",children:"Memory Management in Python - Honeybadger Developer Blog"})})]})}function h(e={}){const{wrapper:o}={...(0,t.a)(),...e.components};return o?(0,n.jsx)(o,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},779441:(e,o,a)=>{a.d(o,{Z:()=>n});const n=a.p+"assets/images/Memory-Management-image1-ab0e36c1511e47f8da97978d2c9a9975.jpg"},511151:(e,o,a)=>{a.d(o,{Z:()=>r,a:()=>s});var n=a(667294);const t={},l=n.createContext(t);function s(e){const o=n.useContext(l);return n.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function r(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),n.createElement(l.Provider,{value:o},e.children)}}}]);